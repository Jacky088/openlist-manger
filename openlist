#!/bin/bash

# OpenList 自动下载执行器
# 每次运行都下载最新脚本并执行

# 颜色配置
RED_COLOR='\e[1;31m'
GREEN_COLOR='\e[1;32m'
YELLOW_COLOR='\e[1;33m'
BLUE_COLOR='\e[1;34m'
CYAN_COLOR='\e[1;36m'
RES='\e[0m'

# 显示欢迎信息
show_welcome() {
    echo -e "${CYAN_COLOR}"
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║                    OpenList 自动下载执行器                    ║"
    echo "║                                                              ║"
    echo "║                   Auto Download & Execute                    ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo -e "${RES}"
}

# 下载并执行脚本
download_and_execute() {
    echo -e "${BLUE_COLOR}正在下载最新版本的OpenList脚本...${RES}"
    
    # 创建临时文件
    local temp_script="/tmp/openlist_$$.sh"
    
    # 下载脚本
    if curl -fsSL "https://raw.githubusercontent.com/ypq123456789/openlist/refs/heads/main/onelist.sh" -o "$temp_script"; then
        # 验证下载的脚本
        if [[ -f "$temp_script" ]] && [[ -s "$temp_script" ]]; then
            # 检查脚本是否包含必要的标识
            if grep -q "OpenList Interactive Manager Script" "$temp_script"; then
                # 设置执行权限
                chmod +x "$temp_script"
                
                echo -e "${GREEN_COLOR}下载成功！正在执行...${RES}"
                echo -e "${YELLOW_COLOR}================================${RES}"
                
                # 执行脚本
                exec "$temp_script" "$@"
            else
                echo -e "${RED_COLOR}下载的文件不是有效的OpenList脚本${RES}"
                rm -f "$temp_script"
                exit 1
            fi
        else
            echo -e "${RED_COLOR}下载的文件无效${RES}"
            rm -f "$temp_script"
            exit 1
        fi
    else
        echo -e "${RED_COLOR}下载失败，请检查网络连接${RES}"
        exit 1
    fi
}

# 检查网络连接
check_network() {
    echo -e "${BLUE_COLOR}检查网络连接...${RES}"
    if ! curl -s --connect-timeout 5 --max-time 10 "https://raw.githubusercontent.com" > /dev/null; then
        echo -e "${RED_COLOR}网络连接失败，无法下载脚本${RES}"
        exit 1
    fi
    echo -e "${GREEN_COLOR}网络连接正常${RES}"
}

# 显示帮助信息
show_help() {
    echo -e "${CYAN_COLOR}OpenList 自动下载执行器使用说明：${RES}"
    echo
    echo -e "${GREEN_COLOR}基本用法：${RES}"
    echo -e "  openlist                    # 下载并执行最新版本"
    echo -e "  openlist install            # 安装OpenList"
    echo -e "  openlist docker_update      # Docker模式更新"
    echo -e "  openlist help               # 显示此帮助信息"
    echo
    echo -e "${YELLOW_COLOR}特性：${RES}"
    echo -e "  ✅ 每次运行都下载最新版本"
    echo -e "  ✅ 自动验证脚本完整性"
    echo -e "  ✅ 网络连接检测"
    echo -e "  ✅ 错误处理机制"
    echo
    echo -e "${BLUE_COLOR}注意：首次运行需要root权限${RES}"
}

# 主函数
main() {
    # 检查参数
    case "${1:-}" in
        "help"|"-h"|"--help")
            show_help
            exit 0
            ;;
        *)
            # 显示欢迎信息
            show_welcome
            
            # 检查网络
            check_network
            
            # 下载并执行
            download_and_execute
            ;;
    esac
}

# 执行主函数
main "$@" 
